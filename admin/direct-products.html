<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #343a40;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        .table {
            margin-bottom: 0;
        }
        .table th {
            border-top: none;
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .badge {
            font-weight: 500;
            padding: 0.5em 0.75em;
        }
        .product-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        #status-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
        }
        .api-response {
            max-height: 300px;
            overflow-y: auto;
        }
        .api-response pre {
            background-color: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .stock-badge {
            font-size: 0.85rem;
        }
        
        /* Responsive styles */
        @media (max-width: 767px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            #status-badge {
                position: static;
                margin-bottom: 15px;
            }
            
            .table {
                font-size: 0.875rem;
            }
            
            .table th, .table td {
                padding: 0.5rem;
            }
            
            .product-image {
                width: 30px;
                height: 30px;
            }
            
            .stock-badge {
                font-size: 0.75rem;
                padding: 0.25em 0.5em;
            }
            
            .card-header h5 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shop me-2"></i>
                E-Commerce Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="bi bi-box me-1"></i>
                            Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../admin/">
                            <i class="bi bi-gear me-1"></i>
                            Admin Panel
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Status Badge -->
    <div id="status-badge"></div>

    <div class="container">
        <!-- Products Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="bi bi-box me-2"></i>
                    Products
                </h5>
                <span id="product-count" class="badge bg-primary">Loading...</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="60">ID</th>
                                <th width="60">Image</th>
                                <th>Product</th>
                                <th class="d-none d-md-table-cell">Category</th>
                                <th>Price</th>
                                <th class="d-none d-md-table-cell">Stock</th>
                                <th class="d-none d-md-table-cell">SKU</th>
                            </tr>
                        </thead>
                        <tbody id="products-body">
                            <tr>
                                <td colspan="7" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading products...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- API Response Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="bi bi-code-slash me-2"></i>
                    API Response
                </h5>
                <button class="btn btn-sm btn-outline-secondary" id="toggle-response">
                    <i class="bi bi-eye me-1"></i>
                    Show/Hide
                </button>
            </div>
            <div class="card-body api-response" id="api-response-container" style="display: none;">
                <pre id="raw-response">Loading...</pre>
            </div>
        </div>
    </div>

    <footer class="bg-light py-3 mt-4">
        <div class="container text-center text-muted">
            <small>&copy; 2023 E-Commerce Dashboard</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statusBadge = document.getElementById('status-badge');
            const productsBody = document.getElementById('products-body');
            const rawResponse = document.getElementById('raw-response');
            const productCount = document.getElementById('product-count');
            const toggleResponseBtn = document.getElementById('toggle-response');
            const apiResponseContainer = document.getElementById('api-response-container');
            
            // Toggle API response visibility
            toggleResponseBtn.addEventListener('click', () => {
                apiResponseContainer.style.display = 
                    apiResponseContainer.style.display === 'none' ? 'block' : 'none';
            });
            
            try {
                // Show loading status
                showStatus('info', 'Fetching products...');
                
                // Fetch products from database
                const response = await fetch('api.php?endpoint=products.php');
                const responseText = await response.text();
                
                // Display raw response
                rawResponse.textContent = responseText;
                
                // Check if response starts with HTML
                if (responseText.trim().startsWith('<')) {
                    showStatus('danger', 'Server returned HTML instead of JSON');
                    productsBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                                Server error: Received HTML instead of JSON
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Check if response is empty
                if (!responseText.trim()) {
                    showStatus('danger', 'Server returned empty response');
                    productsBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                                Server returned empty response
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                try {
                    // Try to parse as JSON
                    const data = JSON.parse(responseText);
                    
                    // Get products array from response (either direct array or from products property)
                    const products = data.products || data;
                    
                    if (Array.isArray(products)) {
                        showStatus('success', `Successfully fetched ${products.length} products`);
                        productCount.textContent = `${products.length} Products`;
                        
                        if (products.length === 0) {
                            productsBody.innerHTML = `
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2 text-muted"></i>
                                        No products found in database
                                    </td>
                                </tr>
                            `;
                        } else {
                            // Render products
                            productsBody.innerHTML = '';
                            products.forEach(product => {
                                const stockBadge = getStockBadge(product.stock_quantity);
                                
                                productsBody.innerHTML += `
                                    <tr>
                                        <td>${product.id}</td>
                                        <td>
                                            ${product.image_url ? 
                                                `<img src="${product.image_url}" alt="${product.name}" class="product-image">` : 
                                                '<span class="badge bg-secondary"><i class="bi bi-image"></i></span>'}
                                        </td>
                                        <td>
                                            <strong>${product.name}</strong>
                                            <div class="small text-muted text-truncate" style="max-width: 250px;">
                                                ${product.description || 'No description'}
                                            </div>
                                            <div class="d-md-none mt-1">
                                                <small class="badge bg-light text-dark">${product.category}</small>
                                                <small>${stockBadge}</small>
                                            </div>
                                        </td>
                                        <td class="d-none d-md-table-cell"><span class="badge bg-light text-dark">${product.category}</span></td>
                                        <td><strong>${parseFloat(product.price).toFixed(2)}</strong></td>
                                        <td class="d-none d-md-table-cell">${stockBadge}</td>
                                        <td class="d-none d-md-table-cell"><code>${product.sku}</code></td>
                                    </tr>
                                `;
                            });
                        }
                    } else {
                        showStatus('danger', 'Response is not an array');
                        productsBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                                    Invalid response format
                                </td>
                            </tr>
                        `;
                    }
                } catch (jsonError) {
                    showStatus('danger', `Failed to parse JSON: ${jsonError.message}`);
                    productsBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                                Invalid JSON response
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                showStatus('danger', `Fetch error: ${error.message}`);
                rawResponse.textContent = `Error: ${error.message}`;
                productsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-wifi-off fs-1 d-block mb-2 text-danger"></i>
                            Failed to fetch products
                        </td>
                    </tr>
                `;
            }
            
            // Helper function to show status badge
            function showStatus(type, message) {
                statusBadge.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show shadow-sm">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
    if (alert && alert.parentNode) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    }
}, 5000);
            }
            
            // Helper function to get stock badge
            function getStockBadge(quantity) {
                if (quantity <= 0) {
                    return `<span class="badge bg-danger stock-badge">Out of stock</span>`;
                } else if (quantity < 10) {
                    return `<span class="badge bg-warning text-dark stock-badge">Low: ${quantity}</span>`;
                } else {
                    return `<span class="badge bg-success stock-badge">In stock: ${quantity}</span>`;
                }
            }
        });
    </script>
</body>
</html>